<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>CMASæœåŠ¡æä¾›è€… - å…¨è‡ªåŠ¨åˆ›å»ºå®¹å™¨</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; padding: 20px; background-color: #f5f5f5; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 15px rgba(0,0,0,0.1); margin-bottom: 20px; }
        h1 { color: #2c3e50; margin-bottom: 25px; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
        .form-group { margin: 20px 0; }
        label { display: inline-block; width: 140px; font-weight: 600; color: #34495e; font-size: 15px; }
        .auto-param { color: #27ae60; font-weight: 600; font-size: 14px; }
        .loading-param { color: #95a5a6; font-style: italic; }
        input[type="file"] { padding: 8px; width: 350px; border: 1px solid #bdc3c7; border-radius: 4px; font-size: 14px; }
        button { 
            padding: 10px 25px; 
            background-color: #3498db; 
            color: white; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            font-size: 14px;
            transition: background-color 0.3s;
        }
        button:hover { background-color: #2980b9; }
        .msg { margin-left: 15px; font-size: 14px; padding: 5px 10px; border-radius: 4px; }
        .success { color: #27ae60; background-color: #eafaf1; }
        .error { color: #e74c3c; background-color: #fdedeb; }
        .loading { color: #3498db; font-style: italic; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #ecf0f1; }
        th { background-color: #f8f9fa; color: #2c3e50; font-weight: 600; }
        tr:hover { background-color: #f8f9fa; }
        .refresh-info { color: #7f8c8d; margin-bottom: 15px; font-size: 14px; }
    </style>
</head>
<body>
    <!-- è‡ªåŠ¨åˆ›å»ºå®¹å™¨è¡¨å• -->
    <div class="container">
        <h1>âœ¨ å…¨è‡ªåŠ¨åˆ›å»ºCMASæœåŠ¡å®¹å™¨</h1>
        
        <!-- è‡ªåŠ¨æ£€æµ‹çš„å¯ç”¨å‚æ•° -->
        <div class="form-group">
            <label>å¯ç”¨æœåŠ¡IDï¼š</label>
            <span id="autoServiceID" class="loading-param">æ­£åœ¨æ£€æµ‹...</span>
        </div>
        <div class="form-group">
            <label>å¯ç”¨å®¹å™¨IPï¼š</label>
            <span id="autoContainerIP" class="loading-param">æ­£åœ¨æ£€æµ‹...</span>
        </div>
        <div class="form-group">
            <label>å¯ç”¨å®¿ä¸»æœºç«¯å£ï¼š</label>
            <span id="autoHostPort" class="loading-param">æ­£åœ¨æ£€æµ‹...</span>
        </div>

        <!-- ä»£ç ä¸Šä¼  -->
        <div class="form-group">
            <label>ä¸Šä¼ æœåŠ¡ä»£ç ï¼š</label>
            <input type="file" id="codeFile" accept=".py,.zip,.tar.gz">
            <button onclick="uploadCode()">ğŸ“¤ ä¸Šä¼ ä»£ç </button>
            <span id="codeMsg" class="msg"></span>
        </div>

        <!-- æ–°å¢åŠŸèƒ½æŒ‰é’® -->
        <div class="form-group">
            <label>ä»£ç æ£€æŸ¥ï¼š</label>
            <button onclick="checkCode()">ğŸ” æ£€æŸ¥ä»£ç </button>
            <span id="checkMsg" class="msg"></span>
        </div>

        <div class="form-group">
            <label>åˆ›å»ºå®¹å™¨å¹¶ä¸Šä¼ ä»£ç ï¼š</label>
            <button onclick="createAndUploadContainer()">ğŸš€ åˆ›å»ºå®¹å™¨å¹¶ä¸Šä¼ ä»£ç </button>
            <span id="uploadMsg" class="msg"></span>
        </div>

        <!-- åˆ›å»ºå®¹å™¨ -->
        <div class="form-group">
            <label></label>
            <button onclick="createContainer()" style="background-color: #27ae60;" disabled>ğŸš€ åˆ›å»ºå¹¶å¯åŠ¨å®¹å™¨</button>
            <span id="createMsg" class="msg"></span>
        </div>
    </div>

    <!-- æŒ‡æ ‡ç›‘æ§åŒºåŸŸ -->
    <div class="container">
        <h1>ğŸ“Š CMASæœåŠ¡æŒ‡æ ‡ç›‘æ§</h1>
        <div class="refresh-info">æœ€ååˆ·æ–°ï¼š<span id="lastRefresh">--</span> | è‡ªåŠ¨åˆ·æ–°ï¼š10ç§’/æ¬¡</div>
        <div id="metricsContainer">
            <div class="loading">æ­£åœ¨åŠ è½½æŒ‡æ ‡æ•°æ®...</div>
        </div>
    </div>

    <script>
        // æ ¸å¿ƒé…ç½®
        const CONFIG = {
            serverIP: "192.168.235.48",
            platformPort: 8081,
            csmaPort: 8083,
            uploadDirBase: "/home/daiyina/cmas-cats-go/services/"
        };

        // å­˜å‚¨è‡ªåŠ¨æ£€æµ‹çš„å¯ç”¨å‚æ•°
        let availableParams = {
            serviceID: "",
            containerIP: "",
            hostPort: ""
        };
        let codePath = ""; // ä¸Šä¼ çš„ä»£ç è·¯å¾„

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æµ‹å¯ç”¨å‚æ•°
        window.onload = function() {
            getAvailableParams(); // è·å–å¯ç”¨å‚æ•°
            loadMetrics();        // åŠ è½½æŒ‡æ ‡
            setInterval(loadMetrics, 10000);
        };

        // 1. è·å–å¯ç”¨å‚æ•°ï¼ˆè°ƒç”¨Platformæ¥å£ï¼‰
        function getAvailableParams() {
            fetch(`http://${CONFIG.serverIP}:${CONFIG.platformPort}/api/get-available-params`)
                .then(response => {
                    if (!response.ok) throw new Error(`æ£€æµ‹å‚æ•°å¤±è´¥ï¼š${response.status}`);
                    return response.json();
                })
                .then(data => {
                    if (data.error) {
                        document.getElementById('autoServiceID').textContent = "æ£€æµ‹å¤±è´¥";
                        document.getElementById('autoContainerIP').textContent = "æ£€æµ‹å¤±è´¥";
                        document.getElementById('autoHostPort').textContent = "æ£€æµ‹å¤±è´¥";
                        alert("æ£€æµ‹å¯ç”¨å‚æ•°å¤±è´¥ï¼š" + data.error);
                        return;
                    }

                    // æ›´æ–°é¡µé¢æ˜¾ç¤º
                    availableParams = data;
                    document.getElementById('autoServiceID').textContent = data.serviceID;
                    document.getElementById('autoContainerIP').textContent = data.containerIP;
                    document.getElementById('autoHostPort').textContent = data.hostPort;
                    document.getElementById('autoServiceID').className = "auto-param";
                    document.getElementById('autoContainerIP').className = "auto-param";
                    document.getElementById('autoHostPort').className = "auto-param";

                    // å¯ç”¨åˆ›å»ºå®¹å™¨æŒ‰é’®
                    document.querySelector('button[onclick="createContainer()"]').disabled = false;
                })
                .catch(error => {
                    document.getElementById('autoServiceID').textContent = "æ£€æµ‹å¤±è´¥";
                    document.getElementById('autoContainerIP').textContent = "æ£€æµ‹å¤±è´¥";
                    document.getElementById('autoHostPort').textContent = "æ£€æµ‹å¤±è´¥";
                    console.error("è·å–å¯ç”¨å‚æ•°å¤±è´¥ï¼š", error);
                });
        }

        // 2. ä¸Šä¼ ä»£ç 
        async function uploadCode() {
            const fileInput = document.getElementById('codeFile');
            const codeMsg = document.getElementById('codeMsg');

            if (!fileInput.files.length) {
                codeMsg.textContent = 'è¯·é€‰æ‹©ä¸€ä¸ªæ–‡ä»¶';
                codeMsg.className = 'msg error';
                return;
            }

            const formData = new FormData();
            formData.append('codeFile', fileInput.files[0]);

            codeMsg.textContent = 'ä¸Šä¼ ä¸­...';
            codeMsg.className = 'msg loading';

            try {
                const response = await fetch('/api/upload/code', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (response.ok) {
                    codeMsg.textContent = `ä¸Šä¼ æˆåŠŸï¼ä»£ç å·²å­˜å‚¨åˆ°: ${result.bestPath}`;
                    codeMsg.className = 'msg success';
                } else {
                    codeMsg.textContent = `ä¸Šä¼ å¤±è´¥: ${result.error}`;
                    codeMsg.className = 'msg error';
                }
            } catch (error) {
                codeMsg.textContent = `ä¸Šä¼ å¤±è´¥: ${error.message}`;
                codeMsg.className = 'msg error';
            }
        }

        // 3. æ£€æŸ¥ä»£ç 
        async function checkCode() {
            const fileInput = document.getElementById('codeFile');
            const checkMsg = document.getElementById('checkMsg');

            if (!fileInput.files.length) {
                checkMsg.textContent = 'è¯·é€‰æ‹©ä¸€ä¸ªæ–‡ä»¶';
                checkMsg.className = 'msg error';
                return;
            }

            const formData = new FormData();
            formData.append('codeFile', fileInput.files[0]);

            checkMsg.textContent = 'æ£€æŸ¥ä¸­...';
            checkMsg.className = 'msg loading';

            try {
                const response = await fetch('/api/check/code', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (response.ok) {
                    checkMsg.textContent = `æ£€æŸ¥é€šè¿‡ï¼š${result.message}`;
                    checkMsg.className = 'msg success';
                } else {
                    checkMsg.textContent = `æ£€æŸ¥å¤±è´¥: ${result.error}`;
                    checkMsg.className = 'msg error';
                }
            } catch (error) {
                checkMsg.textContent = `æ£€æŸ¥å¤±è´¥: ${error.message}`;
                checkMsg.className = 'msg error';
            }
        }

        // 4. åˆ›å»ºå®¹å™¨å¹¶ä¸Šä¼ ä»£ç 
        async function createAndUploadContainer() {
            const fileInput = document.getElementById('codeFile');
            const uploadMsg = document.getElementById('uploadMsg');

            if (!fileInput.files.length) {
                uploadMsg.textContent = 'è¯·é€‰æ‹©ä¸€ä¸ªæ–‡ä»¶';
                uploadMsg.className = 'msg error';
                return;
            }

            const formData = new FormData();
            formData.append('codeFile', fileInput.files[0]);

            uploadMsg.textContent = 'åˆ›å»ºå®¹å™¨å¹¶ä¸Šä¼ ä¸­...';
            uploadMsg.className = 'msg loading';

            try {
                const response = await fetch('/api/upload/code', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (response.ok) {
                    uploadMsg.textContent = `å®¹å™¨åˆ›å»ºæˆåŠŸï¼ä»£ç å·²ä¸Šä¼ åˆ°: ${result.bestPath}`;
                    uploadMsg.className = 'msg success';
                } else {
                    uploadMsg.textContent = `æ“ä½œå¤±è´¥: ${result.error}`;
                    uploadMsg.className = 'msg error';
                }
            } catch (error) {
                uploadMsg.textContent = `æ“ä½œå¤±è´¥: ${error.message}`;
                uploadMsg.className = 'msg error';
            }
        }

        // 5. åˆ›å»ºå®¹å™¨ï¼ˆä½¿ç”¨è‡ªåŠ¨æ£€æµ‹çš„å‚æ•°ï¼‰
        function createContainer() {
            const createMsg = document.getElementById('createMsg');
            
            // æ ¡éªŒ
            if (!codePath) {
                createMsg.className = "msg error";
                createMsg.textContent = "âŒ è¯·å…ˆä¸Šä¼ æœåŠ¡ä»£ç ï¼";
                return;
            }
            if (!availableParams.serviceID) {
                createMsg.className = "msg error";
                createMsg.textContent = "âŒ æœªæ£€æµ‹åˆ°å¯ç”¨å‚æ•°ï¼Œè¯·åˆ·æ–°é¡µé¢ï¼";
                return;
            }

            // æ„å»ºè¯·æ±‚å‚æ•°
            const reqData = {
                serviceID: availableParams.serviceID,
                containerIP: availableParams.containerIP,
                hostPort: availableParams.hostPort,
                codePath: codePath,
                uploadDir: `${CONFIG.uploadDirBase}${availableParams.serviceID}-service/uploads`
            };

            fetch(`http://${CONFIG.serverIP}:${CONFIG.platformPort}/api/docker/create`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(reqData)
            })
            .then(response => {
                if (!response.ok) throw new Error(`HTTPé”™è¯¯ï¼š${response.status}`);
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    createMsg.className = "msg error";
                    createMsg.textContent = `âŒ ${data.error}`;
                } else {
                    createMsg.className = "msg success";
                    createMsg.textContent = `âœ… ${data.msg}`;
                    // é‡ç½®çŠ¶æ€ + é‡æ–°æ£€æµ‹å¯ç”¨å‚æ•°
                    document.getElementById('codeFile').value = "";
                    document.getElementById('codeMsg').textContent = "";
                    codePath = "";
                    getAvailableParams(); // åˆ·æ–°å¯ç”¨å‚æ•°
                    loadMetrics();        // åˆ·æ–°æŒ‡æ ‡
                }
            })
            .catch(error => {
                createMsg.className = "msg error";
                createMsg.textContent = `âŒ åˆ›å»ºå¤±è´¥ï¼š${error.message}`;
            });
        }

        // 4. åŠ è½½æŒ‡æ ‡æ•°æ®
        function loadMetrics() {
            fetch(`http://${CONFIG.serverIP}:${CONFIG.csmaPort}/sync`)
                .then(response => {
                    if (!response.ok) throw new Error(`æ¥å£è®¿é—®å¤±è´¥ï¼š${response.status}`);
                    return response.json();
                })
                .then(data => {
                    const metricsContainer = document.getElementById('metricsContainer');
                    const lastRefresh = document.getElementById('lastRefresh');
                    lastRefresh.textContent = new Date().toLocaleString('zh-CN');

                    if (!data.success) {
                        metricsContainer.innerHTML = `<div class="error">âŒ åŠ è½½å¤±è´¥ï¼š${data.msg || 'æœªçŸ¥é”™è¯¯'}</div>`;
                        return;
                    }

                    const metrics = data.data;
                    if (Object.keys(metrics).length === 0) {
                        metricsContainer.innerHTML = "<div class='loading'>ğŸ“­ æš‚æ— æœåŠ¡æŒ‡æ ‡æ•°æ®</div>";
                        return;
                    }

                    let tableHtml = `
                        <table>
                            <tr>
                                <th>æœåŠ¡ID</th>
                                <th>å®¹å™¨IP:ç«¯å£</th>
                                <th>å¯ç”¨å®ä¾‹æ•°(Gas)</th>
                                <th>æˆæœ¬(Cost)</th>
                                <th>å»¶è¿Ÿ(Delay/ms)</th>
                                <th>çŠ¶æ€</th>
                            </tr>
                    `;

                    for (const serviceId in metrics) {
                        metrics[serviceId].forEach(item => {
                            const status = item.gas > 0 ? 'âœ… æ­£å¸¸' : 'âŒ æ— å¯ç”¨å®ä¾‹';
                            const statusColor = item.gas > 0 ? '#27ae60' : '#e74c3c';
                            tableHtml += `
                                <tr>
                                    <td>${item.service_id}</td>
                                    <td>${item.csci_id}</td>
                                    <td>${item.gas}</td>
                                    <td>${item.cost}</td>
                                    <td>${item.delay}</td>
                                    <td style="color: ${statusColor}; font-weight: 600;">${status}</td>
                                </tr>
                            `;
                        });
                    }

                    tableHtml += "</table>";
                    metricsContainer.innerHTML = tableHtml;
                })
                .catch(error => {
                    document.getElementById('metricsContainer').innerHTML = 
                        `<div class="error">âŒ åŠ è½½æŒ‡æ ‡å¤±è´¥ï¼š${error.message}</div>`;
                });
        }
    </script>
</body>
</html>