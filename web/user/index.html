<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CMAS服务调用平台 - 用户端</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 20px auto;
            padding: 0 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }
        select, textarea, input[type="file"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 14px;
        }
        textarea {
            height: 120px;
            resize: vertical;
        }
        button {
            width: 100%;
            padding: 12px;
            background-color: #165DFF;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        button:disabled {
            background-color: #8BB8FF;
            cursor: not-allowed;
        }
        .result-container {
            margin-top: 30px;
            padding: 20px;
            border: 1px solid #eee;
            border-radius: 4px;
            background-color: #fafafa;
        }
        .result-container h3 {
            margin-top: 0;
            color: #333;
        }
        #result-content {
            margin: 10px 0;
            padding: 15px;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            min-height: 80px;
        }
        #result-content img {
            max-width: 100%;
            max-height: 400px;
            margin-top: 10px;
            border-radius: 4px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            font-size: 14px;
        }
        .status-success {
            background-color: #E8F5E9;
            color: #2E7D32;
        }
        .status-error {
            background-color: #FFEBEE;
            color: #C62828;
        }
        #file-preview {
            margin-top: 8px;
            font-size: 14px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>CMAS服务调用平台</h1>

        <div class="form-group">
            <label for="service-select">选择已注册的服务</label>
            <select id="service-select">
                <option value="S3">S3 - 大模型轻量服务</option>
                <!-- 可添加其他服务选项 -->
            </select>
        </div>

        <div class="form-group">
            <label for="request-data">输入请求数据（文本）</label>
            <textarea id="request-data" placeholder="请输入要发送的文本内容..."></textarea>
        </div>

        <div class="form-group">
            <label for="file-upload">上传附件（可选）</label>
            <input type="file" id="file-upload" accept="image/jpeg,image/png,image/gif" onchange="previewFile()">
            <div id="file-preview"></div>
        </div>

        <button id="submit-btn" onclick="submitRequest()">提交请求</button>

        <div class="result-container" id="result-container" style="display: none;">
            <h3>服务返回结果：</h3>
            <div id="result-content"></div>
            <div id="status" class="status"></div>
        </div>
    </div>

    <script>
        // 替换容器IP为宿主机IP（核心：适配Docker网络）
        function replaceContainerIP(csciId) {
            const [containerIP, containerPort] = csciId.split(':');
            const hostIP = "192.168.235.48"; // 替换为你的服务器真实IP
            const portMap = { "5000": "5003" }; // 容器端口→宿主机端口映射
            return `${hostIP}:${portMap[containerPort] || containerPort}`;
        }

        // 预览上传的文件
        function previewFile() {
            const fileInput = document.getElementById('file-upload');
            const file = fileInput.files[0];
            const previewDiv = document.getElementById('file-preview');
            
            if (file) {
                previewDiv.innerHTML = `已选择文件：${file.name}（${(file.size / 1024).toFixed(2)}KB）`;
            } else {
                previewDiv.innerHTML = '';
            }
        }

        // 提交请求核心逻辑（兼容文本/图片）
        function submitRequest() {
            const serviceId = document.getElementById('service-select').value;
            const requestData = document.getElementById('request-data').value.trim();
            const fileUpload = document.getElementById('file-upload').files[0];
            const submitBtn = document.getElementById('submit-btn');
            const resultContainer = document.getElementById('result-container');
            const resultContent = document.getElementById('result-content');
            const statusDiv = document.getElementById('status');

            // 基础校验
            if (!serviceId) {
                alert('请选择要调用的服务！');
                return;
            }
            if (!requestData && !fileUpload) {
                alert('请输入文本或上传图片！');
                return;
            }

            // 状态初始化
            submitBtn.disabled = true;
            resultContainer.style.display = 'block';
            resultContent.textContent = '正在请求服务，请稍候...';
            statusDiv.className = 'status';
            statusDiv.textContent = '';

            // 步骤1：向CPS请求最优服务节点
            fetch('http://192.168.235.48:8084/select', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    service_id: serviceId,
                    max_accept_cost: 10,
                    max_accept_delay: 30
                })
            })
            .then(response => {
                if (!response.ok) throw new Error(`CPS请求失败：${response.status}`);
                return response.json();
            })
            .then(cpsData => {
                if (!cpsData.success) throw new Error(cpsData.msg || '获取最优节点失败');
                
                const csciId = cpsData.data.csci_id;
                const hostCSCIID = replaceContainerIP(csciId);
                const startTime = Date.now();

                // 步骤2：构建请求（区分文本/图片）
                let fetchOptions;
                if (fileUpload) {
                    // 图片请求：FormData格式
                    const formData = new FormData();
                    formData.append('service_id', serviceId);
                    formData.append('file', fileUpload); // 必须：添加文件
                    formData.append('input', requestData); // 文本描述
                    
                    fetchOptions = {
                        method: 'POST',
                        body: formData // 浏览器自动处理multipart/form-data
                    };
                } else {
                    // 文本请求：JSON格式
                    fetchOptions = {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            service_id: serviceId,
                            input: requestData
                        })
                    };
                }

                // 步骤3：调用S3服务
                return fetch(`http://${hostCSCIID}/run`, fetchOptions)
                .then(response => {
                    if (!response.ok) throw new Error(`服务调用失败：${response.status}`);
                    return response.json();
                })
                .then(siteData => {
                    const endTime = Date.now();
                    const costTime = endTime - startTime;

                    // 展示结果（兼容文本/图片）
                    if (typeof siteData.result === 'object' && siteData.result.image_url) {
                        // 替换图片URL的容器IP为宿主机IP
                        const imageURL = siteData.result.image_url.replace(
                            /http:\/\/.*?:5000/, 
                            `http://${replaceContainerIP('0.0.0.0:5000').split(':')[0]}:5003`
                        );
                        resultContent.innerHTML = `
                            <p>文本回显：${siteData.result.input_text || requestData}</p>
                            <p>图片回显：</p>
                            <img src="${imageURL}" alt="上传的图片">
                            <p>原文件名：${siteData.result.original_filename}</p>
                        `;
                    } else {
                        resultContent.textContent = siteData.result || '无返回数据';
                    }

                    // 成功状态
                    statusDiv.className = 'status status-success';
                    statusDiv.textContent = `请求成功 | 服务节点：${csciId} → 宿主机访问：${hostCSCIID} | 耗时：${costTime}ms`;
                });
            })
            .catch(error => {
                // 失败状态
                resultContent.textContent = '';
                statusDiv.className = 'status status-error';
                statusDiv.textContent = `请求失败：${error.message}`;
            })
            .finally(() => {
                submitBtn.disabled = false;
            });
        }
    </script>
</body>
</html>